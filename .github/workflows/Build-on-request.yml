name: Build on request
on: [workflow_dispatch]

jobs:
  Windows:
    name: Build windows version
    runs-on: windows-2022
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Run vcpkg (manifest mode)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgGitCommitId: 66c0373dc7fca549e5803087b9487edfe3aca0a1
          vcpkgJsonGlob: '.github/vcpkg/vcpkg.json'
          runVcpkgInstall: true
        env:
          VCPKG_DEFAULT_TRIPLET: x86-windows-static

      - name: Integrate vcpkg
        shell: pwsh
        run: |
          & "${{ github.workspace }}\vcpkg\vcpkg.exe" integrate install

      - name: Find solution file
        shell: pwsh
        run: |
          Write-Host "Searching for .sln files..."
          Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object FullName

      - name: Build DirectX
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object -First 1 -ExpandProperty FullName
          if (-not $sln) { throw "No .sln found." }
          MSBuild $sln /m /property:Configuration=DirectX /p:BUILD_REVISION=${{ github.run_number }}

      - name: Build OpenGL
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object -First 1 -ExpandProperty FullName
          if (-not $sln) { throw "No .sln found." }
          MSBuild $sln /m /property:Configuration=OpenGL /p:BUILD_REVISION=${{ github.run_number }}

      - name: Collect executables
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Get-ChildItem -Recurse -Filter "*.exe" |
            Where-Object { $_.Name -in @("otclient_gl.exe","otclient_dx.exe") } |
            ForEach-Object { Copy-Item $_.FullName artifacts }

          if (-not (Get-ChildItem artifacts)) {
            throw "Executables not found. Adjust output path."
          }

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: otclient-windows
          path: artifacts/*
          if-no-files-found: error

      - name: Upload vcpkg logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs
          path: |
            ${{ github.workspace }}/vcpkg/buildtrees/**/*
            ${{ github.workspace }}/vcpkg/installed/vcpkg/info/**/*
          if-no-files-found: ignore