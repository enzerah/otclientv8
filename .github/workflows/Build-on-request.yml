name: Build on request
on: [workflow_dispatch]

jobs:
  Windows:
    name: Build windows version
    runs-on: windows-2022
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Debug - list repo folders and find solutions
        shell: pwsh
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Get-ChildItem -Force $env:GITHUB_WORKSPACE | Format-Table Name,Mode,LastWriteTime
          Write-Host "`nSearching for .sln files..."
          Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object FullName

      - name: Setup MSBuild and add to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Run vcpkg (install deps)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgGitCommitId: 66c0373dc7fca549e5803087b9487edfe3aca0a1
          # Roda o install "clássico" (não-manifest) com triplet + lista de ports
          runVcpkgInstall: true
          runVcpkgFormatString: >
            ["install",
            "boost-iostreams","boost-asio","boost-beast","boost-system","boost-variant","boost-lockfree","boost-process","boost-program-options","boost-uuid","boost-filesystem",
            "luajit","glew","physfs","openal-soft","libogg","libvorbis","zlib","libzip","bzip2","openssl",
            "--triplet","x86-windows-static"]

      - name: Integrate vcpkg
        shell: pwsh
        run: |
          & "${{ github.workspace }}\vcpkg\vcpkg.exe" integrate install

      - name: Build (auto-detect .sln) - DirectX
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object -First 1 -ExpandProperty FullName
          if (-not $sln) { throw "No .sln found in repository. Check checkout/submodules." }
          Write-Host "Using solution: $sln"
          MSBuild $sln /m /property:Configuration=DirectX /p:BUILD_REVISION=${{ github.run_number }}

      - name: Build (auto-detect .sln) - OpenGL
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln $env:GITHUB_WORKSPACE | Select-Object -First 1 -ExpandProperty FullName
          if (-not $sln) { throw "No .sln found in repository. Check checkout/submodules." }
          Write-Host "Using solution: $sln"
          MSBuild $sln /m /property:Configuration=OpenGL /p:BUILD_REVISION=${{ github.run_number }}

      - name: Collect build outputs (best-effort)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\artifacts" | Out-Null
          $exes = Get-ChildItem -Recurse -Filter "otclient_*.exe" $env:GITHUB_WORKSPACE -ErrorAction SilentlyContinue
          if ($exes) {
            $exes | ForEach-Object { Copy-Item $_.FullName "$env:GITHUB_WORKSPACE\artifacts\" -Force }
            Write-Host "Copied:"
            Get-ChildItem "$env:GITHUB_WORKSPACE\artifacts" | Select-Object Name,Length,LastWriteTime
          } else {
            Write-Host "No otclient_*.exe found. You may need to adjust the search/copy pattern."
          }

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: Download-binaries-windows
          path: |
            artifacts/*
          if-no-files-found: error

      - name: Upload vcpkg logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs-windows
          path: |
            ${{ github.workspace }}/vcpkg/buildtrees/**/*
            ${{ github.workspace }}/vcpkg/installed/vcpkg/info/**/*
          if-no-files-found: ignore

  Android:
    name: Build android version
    runs-on: windows-2019
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild and add to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Create data.zip for android
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\create_android_assets.ps1

      - name: Decompress android libs
        shell: pwsh
        run: |
          7z x android_libs.7z -aoa -oC:\android

      - name: Install android NDK
        shell: pwsh
        run: |
          $sdkRoot = "C:\Android\android-sdk"
          $sdkManager = "$sdkRoot\cmdline-tools\latest\bin\sdkmanager.bat"
          Install-AndroidSDKPackages -AndroidSDKManagerPath $sdkManager `
                                    -AndroidSDKRootPath $sdkRoot `
                                    -AndroidPackages "ndk;21.4.7075529"

      - name: Build for android
        timeout-minutes: 25
        shell: pwsh
        run: |
          cd android
          $env:VS_NdkRoot="C:\Android\android-sdk\ndk\21.4.7075529"
          MSBuild.exe /p:Configuration=Release /p:Platform="ARM64" /p:BUILD_REVISION=${{ github.run_number }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: Download-binaries-android
          path: |
            otclientv8.apk
          if-no-files-found: error

  Mac:
    name: Build mac os version
    runs-on: macos-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get latest CMake
        uses: lukka/get-cmake@latest

      - name: MacOS - install physfs pkgconfig luajit xquartz
        run: brew install physfs pkgconfig luajit xquartz

      - name: Run vcpkg (install deps)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgGitCommitId: 66c0373dc7fca549e5803087b9487edfe3aca0a1
          runVcpkgInstall: true
          runVcpkgFormatString: >
            ["install",
            "boost-iostreams","boost-asio","boost-system","boost-variant","boost-lockfree","boost-beast","glew",
            "boost-filesystem","boost-uuid","libogg","libvorbis","zlib","opengl","libzip","openal-soft","bzip2",
            "boost-process","openssl",
            "--triplet","x64-osx"]

      - name: Build with CMake
        uses: lukka/run-cmake@v3
        with:
          buildDirectory: ${{ runner.workspace }}/build
          cmakeAppendedArgs: '-G Ninja -DCMAKE_BUILD_TYPE="Release" -DVERSION=${{ github.run_number }}'
          cmakeListsOrSettingsJson: CMakeListsTxtAdvanced
          useVcpkgToolchainFile: true

      - name: Change name
        run: |
          mv '${{ runner.workspace }}/build/otclient' '${{ runner.workspace }}/build/otclient_mac'

      - name: Upload otclient
        uses: actions/upload-artifact@v4
        with:
          name: Download-binaries-mac
          path: |
            ${{ runner.workspace }}/build/otclient_mac
          if-no-files-found: error

      - name: Upload vcpkg logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs-mac
          path: |
            ${{ github.workspace }}/vcpkg/buildtrees/**/*
            ${{ github.workspace }}/vcpkg/installed/vcpkg/info/**/*
          if-no-files-found: ignore

  Linux:
    name: Build linux version
    runs-on: ubuntu-20.04
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get latest CMake
        uses: lukka/get-cmake@latest

      - name: Ubuntu - install opengl lua5.1 luajit
        run: sudo apt update && sudo apt install -y libglew-dev liblua5.1-0-dev libluajit-5.1-dev

      - name: Run vcpkg (install deps)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgGitCommitId: 66c0373dc7fca549e5803087b9487edfe3aca0a1
          runVcpkgInstall: true
          runVcpkgFormatString: >
            ["install",
            "boost-iostreams","boost-asio","boost-system","boost-variant","boost-lockfree","boost-beast","glew",
            "boost-filesystem","boost-uuid","libogg","libvorbis","zlib","opengl","libzip","openal-soft","bzip2",
            "boost-process","openssl","physfs",
            "--triplet","x64-linux"]

      - name: Build with CMake
        uses: lukka/run-cmake@v3
        with:
          buildDirectory: ${{ runner.workspace }}/build
          cmakeAppendedArgs: '-G Ninja -DCMAKE_BUILD_TYPE="Release" -DVERSION=${{ github.run_number }}'
          cmakeListsOrSettingsJson: CMakeListsTxtAdvanced
          useVcpkgToolchainFile: true

      - name: Change name
        run: |
          mv '${{ runner.workspace }}/build/otclient' '${{ runner.workspace }}/build/otclient_linux'

      - name: Upload otclient
        uses: actions/upload-artifact@v4
        with:
          name: Download-binaries-linux
          path: |
            ${{ runner.workspace }}/build/otclient_linux
          if-no-files-found: error

      - name: Upload vcpkg logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs-linux
          path: |
            ${{ github.workspace }}/vcpkg/buildtrees/**/*
            ${{ github.workspace }}/vcpkg/installed/vcpkg/info/**/*
          if-no-files-found: ignore